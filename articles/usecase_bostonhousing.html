<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Boston Housing Task • mlr3keras</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/journal/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<link href="../extra.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Boston Housing Task">
<meta property="og:description" content="mlr3keras">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a href="https://mlr-org.com"><img src="https://raw.githubusercontent.com/mlr-org/mlr3/master/man/figures/logo.png" id="hexlogo" alt="mlr-org"></a>
        <a class="navbar-brand" href="../index.html">mlr3keras <small>v0.1.3</small></a>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">
    <span class="fa fa fa fa-file-alt"></span>
     
    Reference
  </a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li>
  <a href="https://mlr3book.mlr-org.com">
    <span class="fa fa fa fa-link"></span>
     
    mlr3book
  </a>
</li>
<li>
  <a href="../articles/mlr3keras.html">Get started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usecase_bostonhousing.html">Boston Housing Task</a>
    </li>
  </ul>
</li>
        <li>
  <a href="https://github.com/mlr-org/mlr3keras/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/">
    <span class="fa fa fa fa-comments"></span>
     
  </a>
</li>
<li>
  <a href="https://stackoverflow.com/questions/tagged/mlr3">
    <span class="fab fa-stack-overflow"></span>
     
  </a>
</li>
<li>
  <a href="https://mlr-org.com/">
    <span class="fas fa-rss"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right docsearch" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="usecase_bostonhousing_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Boston Housing Task</h1>
                        <h4 class="author">Henri Funk</h4>
            
            <h4 class="date">2021-02-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/mlr3keras/blob/master/vignettes/usecase_bostonhousing.Rmd"><code>vignettes/usecase_bostonhousing.Rmd</code></a></small>
      <div class="hidden name"><code>usecase_bostonhousing.Rmd</code></div>

    </div>

    
    
<div id="intro" class="section level1">
<h1 class="hasAnchor">
<a href="#intro" class="anchor"></a>Intro</h1>
<p>This use case shows how to use <a href="https://github.com/mlr-org/mlr3keras">mlr3keras</a> on simple <a href="https://www.cs.toronto.edu/~delve/data/boston/bostonDetail.html">Boston Housing Regression Task</a>. Therefore, code from <a href="https://keras.rstudio.com/articles/tutorial_basic_regression.html">Keras Basic Regression Tutorial</a> is translated to <a href="https://mlr3.mlr-org.com">mlr3</a>, respectively <a href="https://github.com/mlr-org/mlr3keras">mlr3keras</a> syntax.</p>
<p>Note, that this tutorial describes how to fit a custom, neural network architecture. This approach can help dealing with specific situations or with incorporating special network structures. <a href="https://github.com/mlr-org/mlr3keras">mlr3keras</a> also offers a few “ready-made” learners that, given that hyperparameters are properly tuned might often yield good performance. Examples for such learners include the <code>kerasff, smlp, smlp2 and tabnet</code> learners. Those methods often also include approaches for handling categorical variables.</p>
<p>This use case extends the tutorial mentioned above by</p>
<ul>
<li>giving an introduction to callbacks and how they can be used</li>
<li>generating reproducible results with <a href="https://github.com/mlr-org/mlr3keras">mlr3keras</a>
</li>
</ul>
<p>As <a href="https://github.com/mlr-org/mlr3keras">mlr3keras</a> is still under heavy development, this might be a good place to look for currently working aspects of the package.</p>
<div id="prerequisites" class="section level2">
<h2 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h2>
<p>This tutorial assumes familiarity with the basics of <a href="https://mlr3pipelines.mlr-org.com">mlr3pipelines</a>. Consult the <a href="https://mlr3book.mlr-org.com/pipelines.html">mlr3book</a> if some aspects are not fully understandable.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com">mlr3</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mlr-org/mlr3keras">mlr3keras</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com">mlr3pipelines</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="basic-regression-task---boston-housing-prices" class="section level1">
<h1 class="hasAnchor">
<a href="#basic-regression-task---boston-housing-prices" class="anchor"></a>Basic Regression Task - Boston Housing Prices</h1>
<p>In this use case, we build a model that predicts the Median value of owner-occupied homes in Boston in $1000’s (<code>medv</code>).</p>
<p>The <code>"Boston Housing Task"</code> is accessible directly from <code>mlr3tasks</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">boston_task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"boston_housing"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span>
  <span class="st">"This data set contains"</span>, <span class="va">boston_task</span><span class="op">$</span><span class="va">nrow</span>, <span class="st">"observations and"</span>,
  <span class="va">boston_task</span><span class="op">$</span><span class="va">ncol</span> <span class="op">-</span> <span class="fl">1</span>, <span class="st">"features."</span>
<span class="op">)</span></code></pre></div>
<pre><code>## [1] "This data set contains 506 observations and 18 features."</code></pre>
<div id="feature-selection" class="section level2">
<h2 class="hasAnchor">
<a href="#feature-selection" class="anchor"></a>Feature selection</h2>
<p>The custom keras regression learner we want to show here only supports numeric features. Consequently we drop all non-numeric features from <code>boston_task</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">boston_task</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span><span class="va">boston_task</span><span class="op">$</span><span class="va">feature_types</span>, <span class="va">type</span> <span class="op">==</span> <span class="st">"numeric"</span><span class="op">)</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></code></pre></div>
<p>The preprocessed data set contains 13 different numeric features:</p>
<ul>
<li>
<code>crim</code> - per capita crime rate by town</li>
<li>
<code>zn</code> - proportion of residential land zoned for lots over 25,000 sq.ft.</li>
<li>
<code>indus</code> - proportion of non-retail business acres per town.</li>
<li>
<code>nox</code> - nitric oxides concentration (parts per 10 million)</li>
<li>
<code>rm</code> - average number of rooms per dwelling</li>
<li>
<code>age</code> - proportion of owner-occupied units built prior to 1940</li>
<li>
<code>dis</code> - weighted distances to five Boston employment centres</li>
<li>
<code>ptratio</code> - pupil-teacher ratio by town</li>
<li>
<code>b</code> - 1000(Bk - 0.63)^2 where Bk is the proportion of blacks by town</li>
<li>
<code>lstat</code> - % lower status of the population</li>
<li>
<code>cmedv</code> - a numeric vector of corrected median values of owner-occupied housing in USD 1000</li>
<li>
<code>lon</code> - a numeric vector of tract point longitudes in decimal degrees</li>
<li>
<code>lat</code> - a numeric vector of tract point latitudes in decimal degrees</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">boston_task</span><span class="op">$</span><span class="fu">head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>##    medv  age      b cmedv    crim    dis indus     lat     lon lstat   nox
## 1: 24.0 65.2 396.90  24.0 0.00632 4.0900  2.31 42.2550 -70.955  4.98 0.538
## 2: 21.6 78.9 396.90  21.6 0.02731 4.9671  7.07 42.2875 -70.950  9.14 0.469
## 3: 34.7 61.1 392.83  34.7 0.02729 4.9671  7.07 42.2830 -70.936  4.03 0.469
##    ptratio    rm zn
## 1:    15.3 6.575 18
## 2:    17.8 6.421  0
## 3:    17.8 7.185  0</code></pre>
<p>Notice that each one of these input data features is stored using a different scale. Although the model might converge without feature normalization, it makes training more difficult, and it makes the resulting model more dependent on the choice of units used in the input. Tp scale the data we create a <code>"PipeOpScale"</code> that is going to be connected to the learner before training.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">po_scale</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/mlr_pipeops_scale.html">PipeOpScale</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="create-the-model" class="section level1">
<h1 class="hasAnchor">
<a href="#create-the-model" class="anchor"></a>Create the model</h1>
<p>As creation of models is very convenient and intuitive in <a href="https://keras.rstudio.com/">keras</a>, <a href="https://github.com/mlr-org/mlr3keras">mlr3keras</a> relies on this syntax for model creation. We wrap our model in a function <code>build_modell</code>. That has several advantages:</p>
<ul>
<li>Each new learner needs a separately build model, if you aim to train a whole new model! Cloning the learner is not sufficient in this case and will lead to continue training one and the same model in a new learner. You might notice a flat history curve in such cases.</li>
<li>A modell is a hyperparameter in a Learner. For this reason a <code>build_modell</code>-functions’ arguments can be used to tune over different modells. For more information about tuning see <a href="https://mlr3book.mlr-org.com/optimization.html">mlr3 manual</a>.</li>
<li>You can easily build models with reproducible and comparable results by assigning a seed to the <code>build_model</code>.</li>
</ul>
<p>Note, that seed setting is not trivial in keras. If you are interested in more details, see chapter Set Seed.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">build_model</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">seed</span> <span class="op">=</span> <span class="fl">123L</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">seed</span> <span class="op">&gt;</span> <span class="fl">0L</span><span class="op">)</span>  <span class="fu"><a href="../reference/mlr3keras_set_seeds.html">mlr3keras_set_seeds</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span>

  <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">64L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>,
                input_shape <span class="op">=</span> <span class="va">boston_task</span><span class="op">$</span><span class="va">ncol</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">64L</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>

    <span class="va">model</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>
    loss <span class="op">=</span> <span class="st">"mse"</span>,
    optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_rmsprop.html">optimizer_rmsprop</a></span><span class="op">(</span><span class="op">)</span>,
    metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"mean_absolute_error"</span><span class="op">)</span>
  <span class="op">)</span>

  <span class="va">model</span>
<span class="op">}</span>

<span class="va">model</span> <span class="op">=</span> <span class="fu">build_model</span><span class="op">(</span><span class="op">)</span>
<span class="va">model</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## Model: "sequential"
## ________________________________________________________________________________
## Layer (type)                        Output Shape                    Param #     
## ================================================================================
## dense_2 (Dense)                     (None, 64)                      896         
## ________________________________________________________________________________
## dense_1 (Dense)                     (None, 64)                      4160        
## ________________________________________________________________________________
## dense (Dense)                       (None, 1)                       65          
## ================================================================================
## Total params: 5,121
## Trainable params: 5,121
## Non-trainable params: 0
## ________________________________________________________________________________</code></pre>
<p>For this use case we create a sequential model, a linear stack of three layers. The shape of our input data is defined in the input layer. Input is analyzed by two densely connected hidden layers. A final denselayer returns a single continuous target estimation value.</p>
</div>
<div id="learner" class="section level1">
<h1 class="hasAnchor">
<a href="#learner" class="anchor"></a>Learner</h1>
<div id="define-hyperparameters" class="section level3">
<h3 class="hasAnchor">
<a href="#define-hyperparameters" class="anchor"></a>Define hyperparameters</h3>
<p>Heading back to <a href="https://mlr3.mlr-org.com">mlr3</a> syntax we set up the keras regression learner like any other and define hyperparameters. Note that the compiled <code>model</code> defined in the previous chapter needs to be defined as a hyperparameter in the learners’ <code>param_set</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com//reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner"</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.keras"</span><span class="op">)</span><span class="op">)</span>
<span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.keras"</span><span class="op">)</span>

<span class="va">learner</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">500L</span>
<span class="va">learner</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">model</span> <span class="op">=</span> <span class="fu">build_model</span><span class="op">(</span><span class="op">)</span>
<span class="va">learner</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">validation_split</span> <span class="op">=</span> <span class="fl">0.2</span></code></pre></div>
</div>
<div id="callbacks" class="section level3">
<h3 class="hasAnchor">
<a href="#callbacks" class="anchor"></a>Callbacks</h3>
<p>Another hypereparameter is <code>callback</code>. A <code>callback</code> is a set of functions, bundled in a list that can be used to explore and manipulate specified progress stages during training. Accordingly a defined <code>callback</code> function is called at its’ specified stage of training to monitor or display specified model parameters at this stage. The history callback, for example, tracks the train and validation loss after each epoch. It stores the training history in a <code>history</code> slot of its’ concerning model object. For a list of all implemented callbacks see <a href="https://keras.io/callbacks/">Keras Callbacks</a>.</p>
<p>In our learner we want to reduce information about training progress. Therefore we create a <code>LambdaCallback</code> that is called at each epochs end and assign it to the learners’ <code>callbacks</code>-hyperparameter. This Callback will print a “.” after every epoch and newline after every 80 epochs.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">print_dot_callback</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/callback_lambda.html">callback_lambda</a></span><span class="op">(</span>
  on_epoch_end <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">epoch</span>, <span class="va">logs</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">epoch</span> <span class="op">%%</span> <span class="fl">80</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"."</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span>

<span class="va">learner</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">callbacks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">print_dot_callback</span><span class="op">)</span></code></pre></div>
<p><a href="https://github.com/mlr-org/mlr3keras">mlr3keras</a> contains a set of often-used callbacks for the user’s convenience.</p>
<ul>
<li>
<code>cb_es</code>: Early stopping callback</li>
<li>
<code>cb_lrs</code>: Learning rate scheduler callback</li>
<li>
<code>cb_tb</code>: Tensorboard callback</li>
<li>
<code>cb_lr_log</code>: Learning rate logger callback</li>
<li>
<code>LogMetrics</code>: Batch-wise Metrics Logger Callback</li>
<li>
<code>SetLogLR</code>: Batch-wise Metrics Setter Callback</li>
</ul>
<p>Initialize early stopping like this:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># early_stop = callback_early_stopping(monitor = "val_loss", patience = 20) # keras syntax</span>
<span class="va">early_stop</span> <span class="op">=</span> <span class="fu"><a href="../reference/cb_es.html">cb_es</a></span><span class="op">(</span>monitor <span class="op">=</span> <span class="st">"val_loss"</span>, patience <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="co"># mlr3 syntax</span></code></pre></div>
</div>
<div id="setting-up-the-learner" class="section level3">
<h3 class="hasAnchor">
<a href="#setting-up-the-learner" class="anchor"></a>Setting up the learner</h3>
<p>We initialize our learner. Note, that we clone the <code>R6</code> object <code>keras_500</code> learner to a second object <code>keras_es</code> that we will use later on.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">keras_500</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/mlr_learners_graph.html">GraphLearner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">po_scale</span> <span class="op">%&gt;&gt;%</span> <span class="va">learner</span><span class="op">)</span>
<span class="va">keras_es</span> <span class="op">=</span> <span class="va">keras_500</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span>deep <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="training" class="section level1">
<h1 class="hasAnchor">
<a href="#training" class="anchor"></a>Training</h1>
<p>Before we train the learner we divide observations randomly into train and test set. The training set contains 404 observations and the test set 102. Now we can train our learner, using the <code>training_id</code>. Reminder: The <code>callback</code> setting vizualizes training progress by a dot after each <code>epoch</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">train_id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">boston_task</span><span class="op">$</span><span class="va">row_ids</span>, <span class="fl">404L</span><span class="op">)</span>
<span class="va">test_id</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="va">boston_task</span><span class="op">$</span><span class="va">row_ids</span>, <span class="va">train_id</span><span class="op">)</span>
<span class="va">keras_500</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">boston_task</span>, row_ids <span class="op">=</span> <span class="va">train_id</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## ................................................................................
## ................................................................................
## ................................................................................
## ................................................................................
## ................................................................................
## ................................................................................
## ....................</code></pre>
<div id="visualize-training-progress" class="section level3">
<h3 class="hasAnchor">
<a href="#visualize-training-progress" class="anchor"></a>Visualize training progress</h3>
<p>Lets’ plot each <code>epochs</code>’ saved history. The plot shows the <code>MAE</code> on training and validation set for each epoch.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">history</span> <span class="op">=</span> <span class="va">keras_500</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">regr.keras</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">history</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">history</span>, metrics <span class="op">=</span> <span class="st">"mean_absolute_error"</span>, smooth <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="usecase_bostonhousing_files/figure-html/plotI-1.png" width="700"></p>
<p>The validation curve noticeably flattens after about 200 epochs. So <code>epochs = 500L</code> seems to be set to high. In this case we can implement the early stopping callback introduced in the previous chapter. <code>early_stop</code> will stop the model if it shows no improvement in <code>val_loss</code> within 20 <code>epochs</code>.</p>
</div>
<div id="train-with-early-stopping" class="section level3">
<h3 class="hasAnchor">
<a href="#train-with-early-stopping" class="anchor"></a>Train with early stopping</h3>
<p>We train exactly the same keras model, using early stopping <code>callback</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">keras_es</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">regr.keras.callbacks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">early_stop</span>, <span class="va">print_dot_callback</span><span class="op">)</span>
<span class="va">keras_es</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">regr.keras.model</span> <span class="op">=</span> <span class="fu">build_model</span><span class="op">(</span><span class="op">)</span>
<span class="va">keras_es</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">boston_task</span>, row_ids <span class="op">=</span> <span class="va">train_id</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## ................................................................................
## ................................................................................
## ................................................................................
## ......................................</code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">history</span> <span class="op">=</span> <span class="va">keras_es</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">regr.keras</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">history</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">history</span>, metrics <span class="op">=</span> <span class="st">"mean_absolute_error"</span>, smooth <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">500</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="usecase_bostonhousing_files/figure-html/earlystopping-1.png" width="700"></p>
<p>Note that each <code>epoch</code> until stopping is exactly the same as in <code>keras_500</code>.</p>
</div>
</div>
<div id="predict-and-evaluate" class="section level1">
<h1 class="hasAnchor">
<a href="#predict-and-evaluate" class="anchor"></a>Predict and evaluate</h1>
<p>In the last step we predict on the test set using <code>keras_es</code>. Prediction is as easy as with any other learner. For prediction we take the <code>test_id</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predict_boston</span> <span class="op">=</span> <span class="va">keras_es</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">boston_task</span>, row_ids <span class="op">=</span> <span class="va">test_id</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">predict_boston</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">tab</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predict_boston</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.mae"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##  regr.mae 
## 0.7864365</code></pre>
<pre><code>## [1] "The models average error is at 786.44$"</code></pre>
</div>
<div id="reproducibility---setting-a-seed" class="section level1">
<h1 class="hasAnchor">
<a href="#reproducibility---setting-a-seed" class="anchor"></a>Reproducibility - Setting a seed</h1>
<p><code>Keras</code> has mutiple sources of stochasticity. Pseudo Random Numbers can be gernerated while</p>
<ul>
<li>initializing weights</li>
<li>ordering in batches</li>
<li>set up model architecture</li>
<li>parallel execution</li>
</ul>
<p>True reproducibility can only be guaranteed if code is not run in parallel and initial weights are fixed. As <code>Keras</code> can run code across multiple devices obtaining reproducible results is not trivial. This chapter suggests ways to easily obtain reproducible results anyways.</p>
<div id="tensorflow-versions" class="section level3">
<h3 class="hasAnchor">
<a href="#tensorflow-versions" class="anchor"></a><code>TensorFlow</code> versions</h3>
<p><code>TensorFlow</code> provides a function to set seeds called <code><a href="https://rdrr.io/pkg/tensorflow/man/use_session_with_seed.html">use_session_with_seed()</a></code>. <a href="https://keras.rstudio.com/articles/faq.html#how-can-i-obtain-reproducible-results-using-keras-during-development">RKerasFAQ</a> shows a convenient way to set seeds by this function. However <code><a href="https://rdrr.io/pkg/tensorflow/man/use_session_with_seed.html">use_session_with_seed()</a></code> appears to work only partly for <code>TensorFlow</code>-version <span class="math inline">\(\ge 2.0\)</span>. If you use <code>TensorFlow</code>-version <span class="math inline">\(&lt; 2.0\)</span> <code><a href="https://rdrr.io/pkg/tensorflow/man/use_session_with_seed.html">use_session_with_seed()</a></code> should run without problems. You can check the current version like this:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tensorflow</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/tf_config.html">tf_version</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>With <code>mlr3keras_set_seeds</code> <code>mlr3 keras</code> provides an alternative solution that should work on any <code>TensorFlow</code>-version.</p>
</div>
<div id="mlr3keras_set_seeds" class="section level3">
<h3 class="hasAnchor">
<a href="#mlr3keras_set_seeds" class="anchor"></a><code>mlr3keras_set_seeds</code>
</h3>
<p>As you might have noticed we have already been using <code>mlr3keras_set_seeds</code> function in this chapter to obtain reproducible results. We introduced this function because in some incidences you might run into an error calling <code><a href="https://rdrr.io/pkg/tensorflow/man/use_session_with_seed.html">use_session_with_seed()</a></code> with <code>TensorFlow</code>-version <span class="math inline">\(&lt; 2.0\)</span>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tensorflow</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/use_session_with_seed.html">use_session_with_seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></code></pre></div>
<pre><code>## Set session seed to 1 (disabled GPU, CPU parallelism)</code></pre>
<p>In these cases it makes sense to use <code>mlr3keras</code> function <code>mlr3keras_set_seeds</code>. <code>mlr3keras_set_seeds</code> establishes a common random seed for <code>R</code>, <code>Python</code>, <code>NumPy</code>, and <code>TensorFlow</code>, disables hash randomization by choice. Note, that you should not have been running <code>TensorFlow</code> before running the function. If you did you might have to restart the session before proceeding.</p>
<p>For more information see <a href="https://stackoverflow.com/questions/59075244/if-keras-results-are-not-reproducible-whats-the-best-practice-for-comparing-mo">Stackoverflow Reset Seeds</a>.</p>
</div>
<div id="non-deterministic-execution" class="section level3">
<h3 class="hasAnchor">
<a href="#non-deterministic-execution" class="anchor"></a>Non-deterministic execution</h3>
<p>GPU computations and CPU parallelize can be another source of non-reproducible results, since both can result in non-deterministic execution patterns. In this case the only way to provide the modell from non-reproducible results is to disable GPU and CPU parallelism. Note, that this can mean a hard trade-off between time and reproducability. <code><a href="https://rdrr.io/pkg/tensorflow/man/use_session_with_seed.html">use_session_with_seed()</a></code> disables both GPU and CPU by default. For more detailed description read the code on <a href="https://github.com/rstudio/tensorflow/blob/master/R/seed.R">Github</a>. <code>mlr3keras_set_seeds</code> provides arguments to disable parallelization by choice. For more information read <a href="https://github.com/mlr-org/mlr3keras/blob/master/R/mlr3keras_set_seeds.R">code documentation on Github</a>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Florian Pfisterer, Jacky Poon, Michel Lang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '9c3abd63d461245fb19ebd2d2645c5b0',
    indexName: 'mlr3',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
